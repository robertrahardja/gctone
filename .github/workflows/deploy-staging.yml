name: Deploy to Staging
on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Git reference to deploy (branch, tag, or commit SHA)'
        required: true
        default: 'main'
      source_environment:
        description: 'Source environment for promotion'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - main-branch
      skip_tests:
        description: 'Skip integration tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '22'
  AWS_REGION: 'ap-southeast-1'
  ENVIRONMENT: 'staging'

jobs:
  pre-deployment-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    
    outputs:
      deployment_approved: ${{ steps.approval.outputs.approved }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}
          
      - name: Validate git reference
        run: |
          echo "ðŸ” Validating git reference: ${{ inputs.git_ref }}"
          git log --oneline -1
          
      - name: Check source environment
        run: |
          echo "ðŸ“‹ Source environment: ${{ inputs.source_environment }}"
          echo "ðŸŽ¯ Target environment: staging"
          
      - name: Manual approval gate
        id: approval
        run: |
          echo "â³ Manual approval required for staging deployment"
          echo "Git ref: ${{ inputs.git_ref }}"
          echo "Source: ${{ inputs.source_environment }}"
          echo "approved=true" >> $GITHUB_OUTPUT

  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment: staging
    needs: pre-deployment-validation
    if: needs.pre-deployment-validation.outputs.deployment_approved == 'true'
    permissions:
      id-token: write
      contents: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Pre-deployment validation
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "ðŸ” Running comprehensive validation..."
          npm test
          npm run lint
          cdk synth
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::521744733620:role/GitHubActions-Staging-Role
          aws-region: ${{ env.AWS_REGION }}
          session-name: GitHubActions-Staging-Deployment
          
      - name: Verify AWS access
        run: |
          echo "ðŸ” Verifying AWS access for staging..."
          caller_identity=$(aws sts get-caller-identity)
          account_id=$(echo "$caller_identity" | jq -r '.Account')
          
          if [ "$account_id" = "521744733620" ]; then
            echo "âœ… Connected to correct staging account: $account_id"
          else
            echo "âŒ Connected to wrong account: $account_id"
            echo "Expected: 521744733620"
            exit 1
          fi
          
      - name: Check CDK bootstrap
        run: |
          echo "ðŸ› ï¸ Verifying CDK bootstrap in staging..."
          aws cloudformation describe-stacks --stack-name cdktoolkit --region ${{ env.AWS_REGION }} > /dev/null 2>&1 || {
            echo "âŒ CDK not bootstrapped in staging account"
            echo "ðŸ’¡ Bootstrap required: cdk bootstrap --qualifier cdk2024"
            exit 1
          }
          echo "âœ… CDK bootstrap verified"
          
      - name: Create deployment snapshot
        run: |
          echo "ðŸ“¸ Creating deployment snapshot..."
          echo "Git SHA: $(git rev-parse HEAD)"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Deployer: ${{ github.actor }}"
          echo "Source: ${{ inputs.source_environment }}"
          
      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "Account: 521744733620"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Git ref: ${{ inputs.git_ref }}"
          
          cdk deploy helloworld-staging \
            --require-approval never \
            --outputs-file outputs-staging.json \
            --context accountId=521744733620
            
      - name: Extract API endpoints
        id: endpoints
        run: |
          if [ -f outputs-staging.json ]; then
            API_URL=$(cat outputs-staging.json | jq -r '.["helloworld-staging"]["helloworldapiurl"] // empty')
            HEALTH_URL=$(cat outputs-staging.json | jq -r '.["helloworld-staging"]["helloworldhealthcheckurl"] // empty')
            
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
            echo "health_url=$HEALTH_URL" >> $GITHUB_OUTPUT
            
            echo "ðŸŒ Staging API URL: $API_URL"
            echo "â¤ï¸ Staging Health URL: $HEALTH_URL"
          else
            echo "âš ï¸ No outputs file found"
          fi
          
      - name: Smoke tests
        if: steps.endpoints.outputs.api_url != ''
        run: |
          echo "ðŸ’¨ Running smoke tests..."
          
          API_URL="${{ steps.endpoints.outputs.api_url }}"
          HEALTH_URL="${{ steps.endpoints.outputs.health_url }}"
          
          # Test main endpoint availability
          echo "Testing main endpoint..."
          if curl -f -s "$API_URL" > /dev/null; then
            echo "âœ… Main endpoint accessible"
          else
            echo "âŒ Main endpoint not accessible"
            exit 1
          fi
          
          # Test health endpoint
          if [ -n "$HEALTH_URL" ]; then
            echo "Testing health endpoint..."
            if curl -f -s "$HEALTH_URL" > /dev/null; then
              echo "âœ… Health endpoint accessible"
            else
              echo "âŒ Health endpoint not accessible"
              exit 1
            fi
          fi
          
      - name: Integration tests
        if: steps.endpoints.outputs.api_url != '' && !inputs.skip_tests
        run: |
          echo "ðŸ§ª Running staging integration tests..."
          
          API_URL="${{ steps.endpoints.outputs.api_url }}"
          
          # Test API response structure and data
          response=$(curl -s "$API_URL")
          echo "API Response: $response"
          
          # Validate JSON structure
          if echo "$response" | jq -e '.message' > /dev/null; then
            echo "âœ… Valid JSON response structure"
          else
            echo "âŒ Invalid JSON response structure"
            exit 1
          fi
          
          # Validate environment-specific data
          environment=$(echo "$response" | jq -r '.environment')
          if [ "$environment" = "staging" ]; then
            echo "âœ… Environment validation passed"
          else
            echo "âŒ Environment validation failed: expected 'staging', got '$environment'"
            exit 1
          fi
          
          # Test memory allocation (staging = 256MB)
          memory_limit=$(echo "$response" | jq -r '.metadata.memoryLimit')
          if [ "$memory_limit" = "256" ]; then
            echo "âœ… Memory allocation correct for staging"
          else
            echo "âš ï¸ Memory allocation unexpected: $memory_limit MB"
          fi
          
      - name: Performance tests
        if: steps.endpoints.outputs.api_url != '' && !inputs.skip_tests
        run: |
          echo "ðŸ“Š Running performance tests..."
          
          API_URL="${{ steps.endpoints.outputs.api_url }}"
          
          # Load testing with multiple requests
          echo "Running load test (10 concurrent requests)..."
          for i in {1..10}; do
            (
              start_time=$(date +%s%N)
              response=$(curl -s "$API_URL")
              end_time=$(date +%s%N)
              duration=$(( (end_time - start_time) / 1000000 ))
              echo "Request $i: ${duration}ms"
              
              # Check for errors in concurrent requests
              if echo "$response" | jq -e '.message' > /dev/null; then
                echo "âœ… Request $i successful"
              else
                echo "âŒ Request $i failed"
              fi
            ) &
          done
          wait
          
          echo "âœ… Performance tests completed"
          
      - name: Security validation
        run: |
          echo "ðŸ”’ Running security validation..."
          
          # Check CORS headers
          API_URL="${{ steps.endpoints.outputs.api_url }}"
          if [ -n "$API_URL" ]; then
            headers=$(curl -I -s "$API_URL")
            
            if echo "$headers" | grep -i "access-control-allow-origin" > /dev/null; then
              echo "âœ… CORS headers present"
            else
              echo "âš ï¸ CORS headers not found"
            fi
          fi
          
          # Validate SSL/TLS
          if [ -n "$API_URL" ]; then
            if echo "$API_URL" | grep -q "https://"; then
              echo "âœ… HTTPS endpoint verified"
            else
              echo "âš ï¸ Not using HTTPS"
            fi
          fi
          
          echo "âœ… Security validation completed"
          
      - name: Update deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Staging deployment successful"
            echo "ðŸŽ¯ Environment ready for user acceptance testing"
            echo "ðŸŒ Staging URL: ${{ steps.endpoints.outputs.api_url }}"
          else
            echo "âŒ Staging deployment failed"
            echo "ðŸ”„ Rollback may be required"
          fi
          
      - name: Create deployment record
        if: success()
        run: |
          echo "ðŸ“ Creating deployment record..."
          cat > deployment-record.json << EOF
          {
            "environment": "staging",
            "git_ref": "${{ inputs.git_ref }}",
            "git_sha": "$(git rev-parse HEAD)",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployer": "${{ github.actor }}",
            "source_environment": "${{ inputs.source_environment }}",
            "api_url": "${{ steps.endpoints.outputs.api_url }}",
            "health_url": "${{ steps.endpoints.outputs.health_url }}",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF
          
          echo "Deployment record:"
          cat deployment-record.json
          
      - name: Notification
        if: always()
        run: |
          status_emoji="âœ…"
          status_text="Success"
          if [ "${{ job.status }}" != "success" ]; then
            status_emoji="âŒ"
            status_text="Failed"
          fi
          
          echo "$status_emoji Staging Deployment $status_text"
          echo "ðŸ“‹ Environment: staging"
          echo "ðŸ”§ Git ref: ${{ inputs.git_ref }}"
          echo "ðŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ðŸŒ URL: ${{ steps.endpoints.outputs.api_url }}"
          
      - name: Cost monitoring
        run: |
          echo "ðŸ’° Staging Cost Monitoring"
          echo "=========================="
          echo "Staging environment monthly cost: ~$3-6 USD"
          echo "Resources deployed:"
          echo "  â€¢ Lambda function (256MB)"
          echo "  â€¢ HTTP API Gateway"
          echo "  â€¢ CloudWatch Log Groups"
          echo ""
          echo "ðŸ’¡ Use './scripts/down.sh' for cost optimization"

  post-deployment:
    name: Post-deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: success()
    
    steps:
      - name: Deployment summary
        run: |
          echo "ðŸŽ‰ Staging Deployment Complete!"
          echo "==============================="
          echo "âœ… Environment: staging"
          echo "âœ… Git reference: ${{ inputs.git_ref }}"
          echo "âœ… Smoke tests: passed"
          echo "âœ… Integration tests: passed"
          echo "âœ… Performance tests: passed"
          echo "âœ… Security validation: passed"
          echo ""
          echo "ðŸš€ Ready for user acceptance testing"
          echo "ðŸ”„ Can be promoted to production when ready"
          
      - name: Next steps
        run: |
          echo "ðŸ“‹ Next Steps"
          echo "============="
          echo "1. ðŸ§ª Conduct user acceptance testing"
          echo "2. ðŸ“Š Monitor performance and errors"
          echo "3. ðŸ” Validate business requirements"
          echo "4. ðŸš€ Promote to production when ready"
          echo ""
          echo "ðŸ’¡ To promote to production:"
          echo "   Use 'Deploy to Production' workflow"
          echo "   Source environment: staging"